<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Tiket | Mahika Trans</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f9; display: flex; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 450px; background: white; min-height: 100vh; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header { background: #065084; color: white; padding: 40px 20px; }
        .header h3 { margin: 0; font-weight: 400; letter-spacing: 2px; font-size: 14px; }
        .header h2 { margin: 10px 0 0; font-size: 28px; font-weight: 700; }
        
        #loading { padding-top: 100px; font-weight: bold; color: #065084; text-align: center; width: 100%; }
        
        .info-section { padding: 30px; text-align: left; color: #333; }
        .info-section p { margin: 0 0 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; font-size: 14px; color: #666; }
        .info-section b { color: #065084; font-size: 16px; float: right; }

        .barcode-section { border-top: 2px dashed #ddd; padding: 30px; background: #fafafa; }
        .barcode-section img { max-width: 100%; height: auto; mix-blend-mode: multiply; }

        .action-area { padding: 20px; }
        .btn-wa { 
            background: #25D366; color: white; border: none; padding: 18px; 
            border-radius: 15px; width: 100%; font-family: 'Poppins'; 
            font-weight: 700; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
            text-decoration: none;
        }
        
        .footer-note { font-size: 11px; color: #aaa; padding: 20px; }
    </style>
</head>
<body>
    <div id="loading"><i class="fas fa-spinner fa-spin"></i> Memvalidasi Tiket...</div>

    <div class="container" id="main" style="display:none">
        <div class="header">
            <h3>MAHIKA TRANS</h3>
            <h2 id="kodeTiket"></h2>
        </div>
        
        <div class="info-section">
            <p>Nama Penumpang <b id="nama"></b></p>
            <p>Kota Tujuan <b id="tujuan"></b></p>
            <p>Jadwal Berangkat <b id="jadwal"></b></p>
            <p>Nomor Kursi <b id="kursi"></b></p>
            <p>Armada <b id="armada"></b></p>
        </div>

        <div class="barcode-section">
            <img id="bc" src="" alt="barcode">
        </div>

        <div class="action-area">
            <a href="#" id="waLink" class="btn-wa">
                <i class="fab fa-whatsapp"></i> Kirim ke Penumpang
            </a>
        </div>

        <div class="footer-note">
            &copy; 2026 Mahika Trans Indonesia.
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbx9JsUb0saYvFnH8vpCn2JZu_AzdrXXXmQIcGfMW0dsTvPndFQC_CtKyLhMx_6Kjd_IEg/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const kode = urlParams.get("kode");

        // FITUR PROTEKSI: TENDANG KE 404 KALAU KODE KOSONG
        if (!kode || kode === "") {
            window.location.href = "404.html";
        }

        async function check() {
            try {
                const res = await fetch(`${API}?action=cekEtiket&kode=${kode}`);
                const result = await res.json();
                
                if(result.status === "success") {
                    const d = result.data;
                    document.getElementById("nama").innerText = d.nama;
                    document.getElementById("tujuan").innerText = d.tujuan;
                    document.getElementById("jadwal").innerText = d.tgl + " | " + d.jam;
                    document.getElementById("kursi").innerText = d.kursi;
                    document.getElementById("armada").innerText = d.armada;
                    document.getElementById("kodeTiket").innerText = d.kode;
                    
                    document.getElementById("bc").src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${d.kode}&scale=3&rotate=N&includetext`;

                    // Ambil nomor HP dari data yang dikirim API (pastikan GAS mengembalikan d.hp)
                    let phone = d.hp || ""; 
                    if (phone.startsWith('0')) phone = '62' + phone.slice(1);
                    
                    const linkEtiket = window.location.href; 
                    const text = `Halo Kak *${d.nama}*, Berikut adalah E-Tiket Mahika Trans Anda.%0A%0AKode: *${d.kode}*%0ATujuan: ${d.tujuan}%0AJadwal: ${d.tgl} - ${d.jam}%0AKursi: ${d.kursi}%0A%0ALihat Tiket Digital:%0A${linkEtiket}%0A%0AMohon datang 30 menit sebelum keberangkatan. Terima kasih!`;
                    
                    document.getElementById("waLink").href = `https://wa.me/${phone}?text=${text}`;

                    document.getElementById("loading").style.display = "none";
                    document.getElementById("main").style.display = "block";
                } else {
                    // JIKA KODE SALAH / TIDAK ADA DI DATABASE, TENDANG JUGA
                    window.location.href = "404.html";
                }
            } catch (e) {
                window.location.href = "404.html";
            }
        }
        
        if (kode) check();
    </script>
</body>
</html>
