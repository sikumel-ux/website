<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Mahika Trans</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #065084; --bg: #043a60; --white: #ffffff; --gold: #FFD700; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary); color: var(--white); margin: 0; padding: 0; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; min-height: 100vh; background: radial-gradient(circle at top right, var(--bg), var(--primary)); padding-bottom: 100px; }
        .header { padding: 40px 20px 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 20px; color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-card span { font-size: 10px; font-weight: 700; color: #888; display: block; text-transform: uppercase; }
        .stat-card strong { font-size: 16px; display: block; margin-top: 5px; color: var(--primary); }
        .list-container { padding: 20px; }
        .item-manifes { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; display: flex; align-items: center; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .tgl-box { width: 45px; height: 45px; background: var(--white); color: var(--primary); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; margin-right: 15px; }
        .info { flex: 1; }
        .info b { font-size: 14px; display: block; }
        .info i { font-size: 11px; opacity: 0.7; font-style: normal; }
        .pax-badge { font-weight: 700; font-size: 14px; color: var(--gold); }
        .nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: var(--white); display: flex; justify-content: space-around; padding: 15px 0; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .nav a { text-decoration: none; color: #ccc; text-align: center; font-size: 10px; flex: 1; }
        .nav a.active { color: var(--primary); }
        .nav i { font-size: 20px; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="font-size: 24px; margin: 0;">Mahika Trans</h1>
        <p style="font-size: 12px; opacity: 0.7; margin: 5px 0 0;">Ringkasan Manifes & Komisi</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span>Komisi Bln Ini</span>
            <strong id="totalKms">Rp 0</strong>
        </div>
        <div class="stat-card">
            <span>Total Pax</span>
            <strong id="totalPax">0 Orang</strong>
        </div>
    </div>

    <div style="padding: 25px 20px 10px; font-weight: 700; opacity: 0.9;">5 Manifes Terakhir</div>
    <div class="list-container" id="listManifes">
        <p style="text-align: center; opacity: 0.5; font-size: 12px;">Menghubungkan ke Sheets...</p>
    </div>
</div>

<div class="nav">
    <a href="index.html" class="active"><i class="fas fa-home"></i>Home</a>
    <a href="input_komisi.html"><i class="fas fa-plus-circle"></i>Input</a>
    <a href="pendapatan.html"><i class="fas fa-chart-bar"></i>Laporan</a>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwYjU8eEgrFHW9w6WsVPUw6H1GJOlXda_6Z-AhWmCBYRzAqCh2Rr8JO1WlDS3KH6YC9/exec";

    async function loadDashboard() {
        try {
            const res = await fetch(`${API}?action=getPendapatan`);
            const data = await res.json();
            
            // Ambil bulan sekarang (MM)
            const blnIni = ("0" + (new Date().getMonth() + 1)).slice(-2);
            
            let kms = 0, pax = 0, html = "";

            // Urutkan data berdasarkan tanggal terbaru
            data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            data.forEach((item, index) => {
                // Hitung statistik bulan ini
                if(item.tanggal && item.tanggal.split("-")[1] === blnIni) {
                    kms += parseInt(item.komisi) || 0;
                    pax += parseInt(item.pax) || 0;
                }

                // Tampilkan 5 manifes teratas
                if(index < 5) {
                    const d = new Date(item.tanggal);
                    const tgl = d.getDate() || "-";
                    const bln = d.toLocaleDateString('id-ID', {month:'short'}) || "-";
                    
                    html += `
                        <div class="item-manifes">
                            <div class="tgl-box"><b>${tgl}</b>${bln}</div>
                            <div class="info">
                                <b>${item.armada || 'Tanpa Nama'}</b>
                                <i>Komisi: Rp ${parseInt(item.komisi || 0).toLocaleString()}</i>
                            </div>
                            <div class="pax-badge">${item.pax || 0} Pax</div>
                        </div>
                    `;
                }
            });

            document.getElementById('totalKms').innerText = "Rp " + kms.toLocaleString('id-ID');
            document.getElementById('totalPax').innerText = pax + " Orang";
            document.getElementById('listManifes').innerHTML = html || "<p style='text-align:center; font-size:12px;'>Belum ada data bulan ini.</p>";

        } catch (e) {
            console.error(e);
            document.getElementById('listManifes').innerHTML = "<p style='text-align:center; color:#ff9999; font-size:12px;'>Gagal memuat data. Cek koneksi atau Deployment API.</p>";
        }
    }
    window.onload = loadDashboard;
</script>
</body>
</html>
